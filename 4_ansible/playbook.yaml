- name: Fleet maintenance and service setup
  hosts: all
  become: true

  tasks:
    - name: Gather system facts
      ansible.builtin.setup:

    # --- Ubuntu: Apache ---
    - name: Update apt repositories
      ansible.builtin.apt:
        update_cache: true
      when: ansible_os_family == "Debian"
    - name: Upgrade all packages
      ansible.builtin.apt:
        upgrade: safe
      when: ansible_os_family == "Debian"

    - name: Install Apache
      ansible.builtin.apt:
        name: apache2
        state: present
      when: ansible_os_family == "Debian"

    - name: Enable and start Apache
      ansible.builtin.systemd:
        name: apache2
        enabled: true
        state: started
      when: ansible_os_family == "Debian"

    - name: Deploy Hello World page
      ansible.builtin.template:
        src: templates/index.html.j2
        dest: /var/www/html/index.html
        owner: www-data
        group: www-data
        mode: "0644"
      when: ansible_os_family == "Debian"
      notify: Restart Apache

    # --- RedHat: MariaDB ---
    - name: Update yum repositories
      ansible.builtin.yum:
        update_cache: true
      when: ansible_os_family == "RedHat"
    - name: Upgrade all packages
      ansible.builtin.yum:
        name: "*"
        state: latest
      when: ansible_os_family == "RedHat"

    - name: Install MariaDB
      ansible.builtin.yum:
        name: mariadb-server
        state: present
      when: ansible_os_family == "RedHat"

    - name: Enable and start MariaDB
      ansible.builtin.systemd:
        name: mariadb
        enabled: true
        state: started
      when: ansible_os_family == "RedHat"

  handlers:
    - ansible.builtin.import_tasks: handlers/main.yml
